services:
  # Build libstratosphere library (required for sysmodule)
  libstratosphere:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace/sysmodule/Atmosphere-libs/libstratosphere
    entrypoint: ["/workspace/scripts/builder/build-wrapper.sh", "libstratosphere", ".", "--lock", ".lock-libstratosphere-build"]
    command: ["nx_release"]

  # Build sysmodule (requires libstratosphere)
  build:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace/sysmodule
    entrypoint: ["/workspace/scripts/builder/build-wrapper.sh", "build", "--lock", ".lock-libstratosphere-build", "--lock", ".lock-sysmodule-build"]
    command: ["all"]
    depends_on:
      - libstratosphere

  # Run tests (host binary with g++)
  test:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace/tests
    command: make test

  # Build Tesla overlay
  overlay:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace/overlay
    entrypoint: ["/workspace/scripts/builder/build-wrapper.sh", "overlay", ".", "--lock", ".lock-overlay-build"]
    command: []

  # Clean sysmodule build artifacts
  clean:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace/sysmodule
    command: make clean

  # Build all targets
  all:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: ["/bin/sh", "-c", "sleep 2; echo '[all] ⏳ Waiting for all builds to complete...'; while ls /workspace/.lock-* >/dev/null 2>&1; do sleep 1; done; echo '[all] ✅ All builds complete'"]
    depends_on:
      - build
      - overlay
    