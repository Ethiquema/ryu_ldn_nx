name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++

      - name: Run tests
        run: |
          cd tests
          make clean
          make test

  build-sysmodule:
    name: Build Sysmodule
    runs-on: ubuntu-latest
    needs: test

    container:
      image: devkitpro/devkita64:latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      warnings: ${{ steps.build.outputs.warnings }}
      errors: ${{ steps.build.outputs.errors }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fix git safe directory
        run: |
          git config --global --add safe.directory /__w/ryu_ldn_nx/ryu_ldn_nx
          git config --global --add safe.directory /__w/ryu_ldn_nx/ryu_ldn_nx/sysmodule/Atmosphere-libs

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Get Atmosphere-libs commit hash
        id: atmosphere-hash
        run: |
          cd sysmodule/Atmosphere-libs
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache libstratosphere
        id: cache-libstratosphere
        uses: actions/cache@v4
        with:
          path: sysmodule/Atmosphere-libs/libstratosphere/lib
          key: libstratosphere-${{ steps.atmosphere-hash.outputs.hash }}

      - name: Build libstratosphere
        if: steps.cache-libstratosphere.outputs.cache-hit != 'true'
        run: |
          cd sysmodule/Atmosphere-libs/libstratosphere
          make nx_release -j$(nproc)

      - name: Build sysmodule
        id: build
        run: |
          cd sysmodule
          # Capture build output
          make -j$(nproc) VERSION="${{ steps.version.outputs.version }}" 2>&1 | tee build.log
          BUILD_STATUS=${PIPESTATUS[0]}

          # Extract warnings and errors
          WARNINGS=$(grep -E "warning:" build.log | grep -v "Atmosphere-libs" | sort -u || true)
          ERRORS=$(grep -E "error:" build.log | sort -u || true)

          # Save to files for artifact upload
          echo "$WARNINGS" > warnings.txt
          echo "$ERRORS" > errors.txt

          # Count
          WARN_COUNT=$(echo "$WARNINGS" | grep -c "warning:" || echo "0")
          ERR_COUNT=$(echo "$ERRORS" | grep -c "error:" || echo "0")

          echo "warnings_count=${WARN_COUNT}" >> $GITHUB_OUTPUT
          echo "errors_count=${ERR_COUNT}" >> $GITHUB_OUTPUT

          exit $BUILD_STATUS

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sysmodule-build-logs
          path: |
            sysmodule/build.log
            sysmodule/warnings.txt
            sysmodule/errors.txt

      - name: Upload sysmodule artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysmodule
          path: |
            sysmodule/ryu_ldn_nx.nsp
            sysmodule/ryu_ldn_nx.nso
            sysmodule/ryu_ldn_nx.npdm
            sysmodule/ryu_ldn_nx.elf
            sysmodule/res/toolbox.json
            sysmodule/res/app.json

  build-overlay:
    name: Build Overlay
    runs-on: ubuntu-latest
    needs: test

    container:
      image: devkitpro/devkita64:latest

    outputs:
      warnings: ${{ steps.build.outputs.warnings }}
      errors: ${{ steps.build.outputs.errors }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build overlay
        id: build
        run: |
          cd overlay
          # Capture build output
          make -j$(nproc) VERSION="${{ steps.version.outputs.version }}" 2>&1 | tee build.log
          BUILD_STATUS=${PIPESTATUS[0]}

          # Extract warnings and errors (exclude libultrahand internal warnings)
          WARNINGS=$(grep -E "warning:" build.log | grep -v "libultrahand" | sort -u || true)
          ERRORS=$(grep -E "error:" build.log | sort -u || true)

          # Save to files
          echo "$WARNINGS" > warnings.txt
          echo "$ERRORS" > errors.txt

          # Count
          WARN_COUNT=$(echo "$WARNINGS" | grep -c "warning:" || echo "0")
          ERR_COUNT=$(echo "$ERRORS" | grep -c "error:" || echo "0")

          echo "warnings_count=${WARN_COUNT}" >> $GITHUB_OUTPUT
          echo "errors_count=${ERR_COUNT}" >> $GITHUB_OUTPUT

          exit $BUILD_STATUS

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: overlay-build-logs
          path: |
            overlay/build.log
            overlay/warnings.txt
            overlay/errors.txt

      - name: Upload overlay artifact
        uses: actions/upload-artifact@v4
        with:
          name: overlay
          path: |
            overlay/ryu_ldn_nx_overlay.ovl
            overlay/ryu_ldn_nx_overlay.elf

  create-release:
    name: Create Release
    needs: [build-sysmodule, build-overlay]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download sysmodule artifacts
        uses: actions/download-artifact@v4
        with:
          name: sysmodule
          path: sysmodule-artifacts

      - name: Download overlay artifacts
        uses: actions/download-artifact@v4
        with:
          name: overlay
          path: overlay-artifacts

      - name: Download sysmodule build logs
        uses: actions/download-artifact@v4
        with:
          name: sysmodule-build-logs
          path: sysmodule-logs

      - name: Download overlay build logs
        uses: actions/download-artifact@v4
        with:
          name: overlay-build-logs
          path: overlay-logs

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Prepare SD card structure
        run: |
          mkdir -p release/atmosphere/contents/4200000000000010/flags
          mkdir -p release/switch/.overlays

          cp sysmodule-artifacts/ryu_ldn_nx.nsp release/atmosphere/contents/4200000000000010/exefs.nsp
          cp sysmodule-artifacts/ryu_ldn_nx.npdm release/atmosphere/contents/4200000000000010/main.npdm
          cp sysmodule-artifacts/res/toolbox.json release/atmosphere/contents/4200000000000010/ || true
          touch release/atmosphere/contents/4200000000000010/flags/boot2.flag
          cp overlay-artifacts/ryu_ldn_nx_overlay.ovl release/switch/.overlays/

          echo "=== Release contents ==="
          find release -type f

      - name: Create ZIP archive
        run: |
          cd release
          zip -r ../ryu_ldn_nx-${{ steps.version.outputs.version }}.zip .

      - name: Generate changelog with collapsible sections
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Start release notes
          cat > CHANGELOG_RELEASE.md << 'HEADER'
          ## ryu_ldn_nx $VERSION

          Nintendo Switch LDN sysmodule for online local multiplayer with Ryujinx servers.

          ### Installation

          1. Extract the ZIP to the root of your SD card
          2. Reboot your Switch
          3. The sysmodule will start automatically
          4. Use Tesla Menu (L+Down+R3) to access the overlay

          HEADER

          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/${VERSION}/g" CHANGELOG_RELEASE.md

          # === CHANGELOG SECTION ===
          echo "<details>" >> CHANGELOG_RELEASE.md
          echo "<summary><strong>üìã Changelog</strong></summary>" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since \`${PREV_TAG}\`:" >> CHANGELOG_RELEASE.md
            echo "" >> CHANGELOG_RELEASE.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> CHANGELOG_RELEASE.md
          else
            echo "- Initial release" >> CHANGELOG_RELEASE.md
          fi

          echo "" >> CHANGELOG_RELEASE.md
          echo "</details>" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          # === WARNINGS SECTION ===
          # Combine warnings from both builds
          cat sysmodule-logs/warnings.txt overlay-logs/warnings.txt 2>/dev/null | grep -v "^$" | sort -u > all_warnings.txt || true
          WARN_COUNT=$(grep -c "warning:" all_warnings.txt 2>/dev/null || echo "0")

          echo "<details>" >> CHANGELOG_RELEASE.md
          echo "<summary><strong>‚ö†Ô∏è Compiler Warnings (${WARN_COUNT})</strong></summary>" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          if [ "$WARN_COUNT" -gt "0" ]; then
            echo '```' >> CHANGELOG_RELEASE.md
            cat all_warnings.txt >> CHANGELOG_RELEASE.md
            echo '```' >> CHANGELOG_RELEASE.md
          else
            echo "_No warnings_" >> CHANGELOG_RELEASE.md
          fi

          echo "" >> CHANGELOG_RELEASE.md
          echo "</details>" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          # === ERRORS SECTION ===
          cat sysmodule-logs/errors.txt overlay-logs/errors.txt 2>/dev/null | grep -v "^$" | sort -u > all_errors.txt || true
          ERR_COUNT=$(grep -c "error:" all_errors.txt 2>/dev/null || echo "0")

          echo "<details>" >> CHANGELOG_RELEASE.md
          echo "<summary><strong>‚ùå Compiler Errors (${ERR_COUNT})</strong></summary>" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          if [ "$ERR_COUNT" -gt "0" ]; then
            echo '```' >> CHANGELOG_RELEASE.md
            cat all_errors.txt >> CHANGELOG_RELEASE.md
            echo '```' >> CHANGELOG_RELEASE.md
          else
            echo "_No errors_" >> CHANGELOG_RELEASE.md
          fi

          echo "" >> CHANGELOG_RELEASE.md
          echo "</details>" >> CHANGELOG_RELEASE.md

          # Show generated changelog
          echo "=== Generated Release Notes ==="
          cat CHANGELOG_RELEASE.md

      - name: Upload release ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ryu_ldn_nx-${{ steps.version.outputs.version }}
          path: ryu_ldn_nx-${{ steps.version.outputs.version }}.zip

      - name: Upload debug ELFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ryu_ldn_nx-${{ steps.version.outputs.version }}-debug
          path: |
            sysmodule-artifacts/ryu_ldn_nx.elf
            overlay-artifacts/ryu_ldn_nx_overlay.elf

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ryu_ldn_nx ${{ steps.version.outputs.version }}
          body_path: CHANGELOG_RELEASE.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            ryu_ldn_nx-${{ steps.version.outputs.version }}.zip
            sysmodule-artifacts/ryu_ldn_nx.elf
            overlay-artifacts/ryu_ldn_nx_overlay.elf
