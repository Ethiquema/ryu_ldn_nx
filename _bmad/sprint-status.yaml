# BMM Sprint Status Tracking
# Generated: 2026-01-12
# Project: ryu_ldn_nx - Port de ryu_ldn vers Nintendo Switch native

project:
  name: "ryu_ldn_nx"
  description: "Port de ryu_ldn pour fonctionner nativement sur Nintendo Switch comme sysmodule Atmosphere"
  type: greenfield
  scope: medium-complex
  flow: structured
  languages:
    - C
    - C++
  license: GPLv3
  contributions: DCO

# Sources du projet
sources:
  nintendo_clients_wiki: "https://github.com/kinnay/NintendoClients/wiki"
  switchbrew_docs: "https://switchbrew.org/wiki/Main_Page"
  switchbrew_hardware: "https://switchbrew.org/wiki/Hardware"
  ryujinx_source: "https://git.ryujinx.app/ryubing/ryujinx"
  ldn_server: "https://git.ryujinx.app/ryubing/ldn"
  ldn_mitm_original: "https://github.com/spacemeowx2/ldn_mitm"

# Phase actuelle
phase:
  current: execution
  status: in_progress

# Phases complétées
discovery:
  status: completed
  product_brief: docs/product-brief.md
  codebase_analysis: docs/codebase-analysis.md
  research_notes: docs/research-notes.md

solutioning:
  status: completed
  architecture: docs/architecture.md

planning:
  status: completed
  epics_created: 7
  stories_created: 48
  estimated_sprints: 8-9

# Epics
epics:
  - id: 0
    name: "Infrastructure Projet"
    priority: P0
    status: completed
    stories_completed: 6
    stories_total: 6
    file: docs/epics/epic-0-infrastructure.md

  - id: 1
    name: "Protocole RyuLdn"
    priority: P0
    status: completed
    stories_completed: 6
    stories_total: 6
    depends_on: [0]
    file: docs/epics/epic-1-protocol.md

  - id: 2
    name: "Client Réseau"
    priority: P0
    status: completed
    stories_completed: 8
    stories_total: 8
    depends_on: [0, 1]
    file: _bmad/epics/epic-2-network-client.md

  - id: 3
    name: "Service LDN (MITM IPC)"
    priority: P0
    status: completed
    stories_completed: 9
    stories_total: 9
    depends_on: [0, 1, 2]
    file: _bmad/epics/epic-3-ldn-service.md

  - id: 4
    name: "Tesla Overlay"
    priority: P2
    status: completed
    stories_completed: 6
    stories_total: 6
    depends_on: [0, 3]
    file: _bmad/epics/epic-4-tesla-overlay.md

  - id: 5
    name: "Documentation & Release"
    priority: P1
    status: in_progress
    stories_completed: 4
    stories_total: 7
    depends_on: [0, 1, 2, 3, 4]
    file: _bmad/epics/epic-5-docs-release.md

  - id: 6
    name: "Runtime LDN Info + Config Lock"
    priority: P1
    status: paused
    stories_completed: 0
    stories_total: 6
    depends_on: [3, 4]
    file: _bmad/epics/epic-6-runtime-info.md

  - id: 7
    name: "Packet Handlers Refactoring"
    priority: P1
    status: in_progress
    stories_completed: 3
    stories_total: 6
    depends_on: [3]
    file: _bmad/epics/epic-7-packet-handlers.md

  - id: 8
    name: "BSD Socket MITM (Proxy Data Routing)"
    priority: P0
    status: in_progress
    stories_completed: 8
    stories_total: 9
    depends_on: [3]
    file: _bmad/epics/epic-8-bsd-mitm.md
    notes: |
      Stories 8.1-8.8 COMPLETE. Story 8.9 (Tests intégration) pending.
      Implémentation BSD MITM fonctionnelle avec ProxyData routing.

  - id: 9
    name: "P2P Proxy & BSD Avancé"
    priority: P1
    status: in_progress
    stories_completed: 8
    stories_total: 9
    depends_on: [8]
    file: _bmad/epics/epic-9-p2p-proxy.md
    notes: |
      Post-MVP optimization for direct P2P connections.
      Stories 9.1-9.8 COMPLETE:
      - ✅ TCP Accept queue (Story 9.1)
      - ✅ TCP Connect handshake (Story 9.2)
      - ✅ Broadcast filtering (Story 9.3)
      - ✅ UPnP wrapper switch-miniupnpc (Story 9.4) - 25 tests
      - ✅ P2pProxyServer (Story 9.5) - 27 tests
      - ✅ P2pProxyClient (Story 9.6) - 31 tests
      - ✅ HandleExternalProxy integration (Story 9.7) - 35 tests
      - ✅ CreateNetwork avec P2P (Story 9.8) - 40 tests

      Remaining (P2P integration):
      - Story 9.9: Integration tests

# Execution en cours
execution:
  current_epic: 9
  current_story: "9.9"
  stories_completed:
    # Epic 0 - Infrastructure
    - "0.1: Docker Build Environment"
    - "0.2: Structure projet sysmodule"
    - "0.3: Fichiers open source"
    - "0.4: Templates GitHub"
    - "0.5: CI/CD Build de base"
    - "0.6: Configuration exemple"
    # Epic 1 - Protocole
    - "1.1: Structures de données de base"
    - "1.2: Structures de messages"
    - "1.3: Encodeur de paquets"
    - "1.4: Décodeur de paquets"
    - "1.5: Gestionnaire de buffer"
    - "1.6: Tests protocole"
    # Epic 2 - Client Réseau
    - "2.1: Configuration Manager"
    - "2.2: Socket TCP de base"
    - "2.3: Client TCP avec protocole"
    - "2.4: Machine à états connexion"
    - "2.5: Reconnexion automatique"
    - "2.6: Client RyuLdn complet"
    - "2.7: Tests unitaires réseau"
    - "2.8: Tests intégration réseau"
    # Epic 3 - Service LDN
    - "3.1: Types LDN Nintendo"
    - "3.2: Machine à états LDN"
    - "3.3: Service MITM de base"
    - "3.4: Gestion des scans"
    - "3.5: Création réseau (Host)"
    - "3.6: Connexion réseau (Client)"
    - "3.7: Proxy de données"
    - "3.8: Gestion des erreurs LDN"
    - "3.9: Tests intégration LDN"
    # Epic 4 - Tesla Overlay
    - "4.1: Structure overlay Tesla"
    - "4.2: Menu principal"
    - "4.3: Configuration serveur"
    - "4.4: Affichage statut"
    - "4.5: Actions connexion"
    - "4.6: Build overlay"
    # Epic 5 - Documentation (partiel)
    - "5.1: Site Starlight"
    - "5.2: Documentation API (Doxygen)"
    - "5.3: Guides utilisateur"
    - "5.4: GitHub Actions docs"
    # Epic 9 - P2P Proxy
    - "9.1: TCP Accept queue"
    - "9.2: TCP Connect handshake"
    - "9.3: Broadcast filtering"
    - "9.4: Wrapper UPnP switch-miniupnpc"
    - "9.5: P2pProxyServer (Host TCP)"
    - "9.6: P2pProxyClient (Joiner TCP)"
    - "9.7: HandleExternalProxy integration"
    - "9.8: CreateNetwork avec P2P"

next_actions:
  # Epic 8 - BSD MITM - ALMOST DONE
  - "Story 8.9: Tests d'intégration MK8DX"

  # Epic 9 - P2P Proxy (en cours)
  - "Story 9.9: Tests d'intégration P2P"

# Fichiers principaux du projet
files_created:
  # Infrastructure
  - "Dockerfile"
  - "docker-compose.yml"
  - ".gitignore"
  - "README.md"
  - "LICENSE"
  - "CONTRIBUTING.md"
  - "CODE_OF_CONDUCT.md"
  - "SECURITY.md"
  - "CHANGELOG.md"
  # GitHub
  - ".github/ISSUE_TEMPLATE/*"
  - ".github/PULL_REQUEST_TEMPLATE.md"
  - ".github/CODEOWNERS"
  - ".github/workflows/build.yml"
  - ".github/workflows/docs.yml"
  - ".github/workflows/release.yml"
  # Sysmodule
  - "sysmodule/Makefile"
  - "sysmodule/source/main.cpp"
  - "sysmodule/source/config/config.hpp"
  - "sysmodule/source/config/config.cpp"
  - "sysmodule/source/protocol/*.hpp"
  - "sysmodule/source/network/*.hpp"
  - "sysmodule/source/network/*.cpp"
  - "sysmodule/source/ldn/*.hpp"
  - "sysmodule/source/ldn/*.cpp"
  # Overlay
  - "overlay/Makefile"
  - "overlay/source/main.cpp"
  # Tests
  - "tests/Makefile"
  - "tests/*_tests.cpp"
  # Documentation
  - "docs/astro.config.mjs"
  - "docs/package.json"
  - "docs/scripts/generate-api-docs.mjs"
  - "docs/Doxyfile"
  - "docs/src/content/docs/**/*.mdx"
  # Config
  - "config/ryu_ldn_nx/config.ini.example"

# Critères MVP
mvp_criteria:
  - "Sysmodule s'installe sur Switch"
  - "Connexion au serveur ryu_ldn réussit"
  - "Mario Kart 8 Deluxe peut créer une partie"
  - "Mario Kart 8 Deluxe peut rejoindre une partie"
  - "Session stable pendant 1 heure"

# Workflows suggérés
suggested_workflows:
  - "/dev-story - Implémenter la prochaine story"
  - "/workflow-status - Voir statut actuel"

# Notes
notes: |
  Phase Execution démarrée le 2026-01-12.
  Epic 0 (Infrastructure) COMPLETE - 6/6 stories.
  Epic 1 (Protocole) COMPLETE - 6/6 stories - 28 tests.
  Epic 2 (Client Réseau) COMPLETE - 8/8 stories - 198 tests.
  Epic 3 (Service LDN) COMPLETE - 9/9 stories - 156 tests.
  Epic 4 (Tesla Overlay) COMPLETE - 6/6 stories - overlay.ovl compilé.
  Epic 5 (Documentation) EN COURS - 4/7 stories.
  Epic 6 (Runtime Info) PAUSED - 0/6 stories.
  Epic 7 (Packet Handlers) EN COURS - 3/6 stories.
  Epic 8 (BSD MITM) PRESQUE COMPLET - 8/9 stories.
  Epic 9 (P2P Proxy) EN COURS - 7/9 stories - Post-MVP optimization.

  2026-01-15: BSD MITM IMPLEMENTATION COMPLETE
  Stories 8.2-8.8 implemented:
  - BSD types and IPC interface
  - ProxySocket and ProxySocketManager
  - BSD MITM Service with forwarding
  - Bind/Connect interception for LDN
  - Send/Recv routing via ProxyData
  - Poll/Select/Fcntl/Ioctl support
  - GetPeerName/GetSockName/GetSockOpt/SetSockOpt

  2026-01-15: EPIC 9 CREATED (P2P Proxy)
  Analysis of Ryujinx P2P system complete. Stories created for:
  - TCP Accept queue and Connect handshake
  - Broadcast filtering
  - miniupnpc port for Switch (UPnP NAT punch)
  - P2pProxyServer and P2pProxyClient
  - Full P2P integration

  2026-01-15: EPIC 9 Stories 9.1-9.3 COMPLETE
  BSD primitives implementées:
  - TCP Accept queue (ProxySocket avec queue et Accept())
  - TCP Connect handshake (ProxyConnect/ProxyConnectReply)
  - Broadcast filtering (SO_BROADCAST flag)
  Ces primitives sont nécessaires pour le système P2P complet.
  switch-miniupnpc disponible via devkitPro (simplifie Story 9.4).

  2026-01-15: Story 9.4 COMPLETE - UPnP Wrapper
  Implémentation complète avec switch-miniupnpc:
  - UpnpPortMapper singleton avec Discover/Add/DeletePortMapping
  - GetExternalIPAddress, GetLocalIPAddress, GetLocalIPv4
  - RefreshPortMapping pour lease renewal
  - Thread-safe avec mutex
  - 25 tests unitaires passent (0 warnings)

  2026-01-15: Story 9.5 COMPLETE - P2pProxyServer
  Implémentation complète du serveur P2P host:
  - P2pProxyServer: TCP server sur port 39990-39999
  - P2pProxySession: gestion connexions clients individuelles
  - Token-based authentication (ExternalProxyToken)
  - Message routing: ProxyData, ProxyConnect, ProxyConnectReply, ProxyDisconnect
  - UPnP NAT punch via UpnpPortMapper
  - Accept loop + per-session receive threads
  - Lease renewal thread pour UPnP (50s interval)
  - 27 tests unitaires passent

  2026-01-16: Story 9.6 COMPLETE - P2pProxyClient
  Implémentation complète du client P2P joiner:
  - P2pProxyClient: TCP client avec Connect/Disconnect
  - PerformAuth: envoi ExternalProxyConfig (0x26 bytes)
  - EnsureProxyReady: attente ProxyConfig avec timeout
  - Receive thread pour paquets entrants
  - ProxyPacketCallback pour routing vers BSD MITM
  - FAILURE_TIMEOUT_MS = 4000ms (Ryujinx compatible)
  - CONNECT_TIMEOUT_MS = 5000ms
  - 31 tests unitaires passent

  2026-01-16: Story 9.7 COMPLETE - HandleExternalProxy Integration
  Intégration complète P2pProxyClient dans ICommunicationService:
  - HandleExternalProxyConnect(): création et connexion P2pProxyClient
  - DisconnectP2pProxy(): cleanup propre du client P2P
  - SendProxyDataToServer(): routing intelligent P2P vs master server
  - ProxyPacketCallback: routing paquets P2P vers BSD MITM
  - Support IPv4 via address_family == 2 (AF_INET)
  - Cleanup automatique dans destructeur et DisconnectFromServer()
  - 35 tests unitaires passent

  2026-01-16: Story 9.8 COMPLETE - CreateNetwork avec P2P
  Intégration complète P2pProxyServer dans CreateNetwork (host-side):
  - StartP2pProxyServer(): démarrage serveur P2P avec callback user_data pattern
  - StopP2pProxyServer(): cleanup propre du serveur P2P
  - HandleExternalProxyToken(): gestion tokens pour joiners attendus
  - CreateNetwork(): démarre P2P + UPnP, remplit RyuNetworkConfig
  - DestroyNetwork()/CloseAccessPoint(): cleanup P2P server
  - MasterSendCallback modifié pour supporter user_data (fonction pointer compatible)
  - send_raw()/send_raw_packet() ajoutés pour envoi paquets pré-encodés
  - 40 tests unitaires passent

  Total: 527+ tests unitaires passent.
  Builds: sysmodule.nsp, overlay.ovl, documentation Starlight.
